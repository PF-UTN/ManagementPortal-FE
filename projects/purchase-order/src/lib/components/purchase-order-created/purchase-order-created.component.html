<mp-loading *ngIf="isLoading()" class="purchase-order__loading-message"></mp-loading>

<div *ngIf="!isLoading()" class="purchase-order__wrapper">
    <div class="purchase-order__header">
        <button mat-icon-button (click)="goBack()" aria-label="Volver" class="purchase-order__actions__item">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <mp-title class="purchase-order__header__title">Nueva Orden de Compra</mp-title>
    </div>
    <hr />

    <div class="container">
        <mat-stepper orientation="vertical" [linear]="true" #stepper class="purchase-order__stepper">
            <!-- Paso 1: Datos de la Orden -->
            <mat-step [stepControl]="form.controls.header">
                <form [formGroup]="form.controls.header">
                    <ng-template matStepLabel>Datos de la Orden</ng-template>
                    <div class="row mt-2">
                        <!-- Proveedor -->
                        <div class="col-8">
                            <mat-form-field appearance="outline" class="purchase-order__form-field">
                                <mat-label>Proveedor</mat-label>
                                <input type="text" matInput formControlName="supplier" [matAutocomplete]="autoSupplier"
                                    placeholder="Seleccionar proveedor" [attr.autocomplete]="'off'"
                                    class="purchase-order__form-field__input" />
                                <button type="button" matSuffix mat-icon-button aria-label="Clear"
                                    (click)="onClearOrder()" class="purchase-order__actions__item">
                                    <mat-icon aria-hidden="false" fontIcon="close"></mat-icon>
                                </button>
                                <mat-autocomplete #autoSupplier="matAutocomplete" [displayWith]="displaySupplierName"
                                    (optionSelected)="onSupplierSelected($event)">
                                    <mat-option *ngFor="let supplier of filteredSuppliers$ | async" [value]="supplier">
                                        {{ supplier.businessName }}
                                    </mat-option>
                                </mat-autocomplete>
                                <mat-error
                                    *ngIf="form.controls.header.controls.supplier?.hasError('required') && form.controls.header.controls.supplier?.touched">
                                    El proveedor es requerido
                                </mat-error>
                                <mat-error
                                    *ngIf="form.controls.header.controls.supplier?.hasError('invalidSupplier') && form.controls.header.controls.supplier?.touched">
                                    Debe seleccionar un proveedor de la lista.
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Fecha estimada de entrega -->
                        <div class="col-4">
                            <mat-form-field appearance="outline" class="purchase-order__form-field">
                                <mat-label>Fecha estimada de entrega</mat-label>
                                <input matInput [matDatepicker]="picker" formControlName="estimatedDeliveryDate"
                                    required class="purchase-order__form-field__input">
                                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                                <mat-datepicker #picker></mat-datepicker>
                            </mat-form-field>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <mp-input label="Observaciones" [textarea]="true"
                                [formControl]="form.controls.header.controls.observation"
                                placeholder="Escriba sus observaciones"
                                [errorMessages]="{ maxlength: 'No puede superar los 100 caracteres.' }" icon="close"
                                class="purchase-order__form-field__input"></mp-input>
                        </div>
                    </div>

                    <div>
                        <button mat-button matStepperNext [disabled]="!form.controls.header.valid"
                            class="purchase-order__buttons__item">
                            Siguiente
                        </button>
                    </div>
                </form>
            </mat-step>

            <!-- Paso 2: Productos -->
            <mat-step [stepControl]="form.controls.items">
                <form [formGroup]="form">
                    <ng-template matStepLabel>Productos</ng-template>
                    <div class="row mt-2">
                        <!-- Lista de productos del proveedor -->
                        <div class="col-4">
                            <mat-form-field appearance="fill" class="purchase-order__form-field mb-3">
                                <mat-label>Buscar productos</mat-label>
                                <input matInput formControlName="searchText" (input)="onSearchProducts()"
                                    placeholder="Buscar producto" class="purchase-order__form-field__input">
                                <button type="button" matSuffix mat-icon-button aria-label="Clear"
                                    (click)="form.controls.searchText.reset(); onSearchProducts()"
                                    class="purchase-order__actions__item">
                                    <mat-icon aria-hidden="false" fontIcon="close"></mat-icon>
                                </button>
                            </mat-form-field>
                            <mp-list [columns]="productColumns" [items]="filteredProducts"
                                [noDataMessage]="'No hay productos disponibles para este proveedor.'"
                                [isLoading]="isLoadingProducts()" class="purchase-order__list">
                            </mp-list>
                        </div>

                        <!-- Lista de productos seleccionados -->
                        <div class="col-8">
                            <mp-title class="purchase-order__header__title">Productos seleccionados</mp-title>
                            <div *ngIf="items.length === 0" class="purchase-order__loading-message">
                                No se han agregado productos.
                            </div>
                            <div class="purchase-order__table__scrollable" *ngIf="items.length > 0">
                                <table class="purchase-order__table">
                                    <thead>
                                        <tr>
                                            <th class="purchase-order__table__col-3">Nombre del Producto</th>
                                            <th class="purchase-order__table__col-3">Cantidad</th>
                                            <th class="purchase-order__table__col-3">Precio</th>
                                            <th class="purchase-order__table__col-2">Subtotal</th>
                                            <th class="purchase-order__table__col-1"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let item of items.controls; let i = index" [formGroup]="item">
                                            <td class="purchase-order__table__cell">{{
                                                getProductName(item.controls.productId.value) }}</td>
                                            <td class="purchase-order__table__cell">
                                                <mat-form-field appearance="outline" class="purchase-order__form-field">
                                                    <mat-label>Cantidad</mat-label>
                                                    <input matInput type="number" formControlName="quantity"
                                                        placeholder="Cantidad"
                                                        class="purchase-order__form-field__input" />
                                                    <mat-error *ngIf="item.controls.quantity?.hasError('min')">
                                                        Cantidad debe ser mayor a 0
                                                    </mat-error>
                                                </mat-form-field>
                                            </td>
                                            <td class="purchase-order__table__cell">
                                                <mat-form-field appearance="outline" class="purchase-order__form-field">
                                                    <mat-label>Precio</mat-label>
                                                    <span matTextPrefix>$&nbsp;</span>
                                                    <input matInput type="number" formControlName="unitPrice"
                                                        placeholder="Precio"
                                                        class="purchase-order__form-field__input" />
                                                    <mat-error *ngIf="item.controls.unitPrice?.hasError('min')">
                                                        Precio debe ser mayor a 0.
                                                    </mat-error>
                                                </mat-form-field>
                                            </td>
                                            <td class="purchase-order__table__cell purchase-order__table__subtotal">
                                                {{ (item.controls.quantity.value || 0) * (item.controls.unitPrice.value
                                                || 0) | currency:'ARS':'symbol':'1.2-2' }}
                                            </td>
                                            <td class="purchase-order__table__cell">
                                                <button mat-icon-button
                                                    (click)="removeProduct(item.controls.productId.value ?? -1)"
                                                    class="purchase-order__actions__item">
                                                    <mat-icon>delete</mat-icon>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div>
                        <!-- Total debajo de la tabla -->
                        <div class="purchase-order__total mt-3">
                            <span><strong>Total: {{ calculateTotal() | currency:'ARS':'symbol':'1.2-2'
                                    }}</strong></span>
                        </div>

                        <!-- Botones de navegación -->
                        <div class="purchase-order__buttons">
                            <button mat-button matStepperPrevious
                                class="purchase-order__buttons__item">Anterior</button>
                            <button mat-button matStepperNext
                                [disabled]="!form.controls.items.valid || items.length === 0"
                                class="purchase-order__buttons__item">Siguiente</button>
                        </div>
                    </div>
                </form>
            </mat-step>

            <!-- Paso 3: Resumen -->
            <mat-step [stepControl]="form">
                <div class="purchase-order__summary">
                    <ng-template matStepLabel>Detalle</ng-template>
                    <!-- Encabezado de la orden de compra -->
                    <div class="purchase-order__header">
                        <mp-title class="purchase-order__header__title mb-3">Resumen de la Orden de Compra</mp-title>
                        <p><strong>Proveedor: </strong>{{ form.controls.header.value.supplier?.businessName }}</p>
                        <p><strong>Fecha: </strong>{{ form.controls.header.value.estimatedDeliveryDate |
                            date:'dd/MM/yyyy' }}</p>
                    </div>

                    <!-- Lista de productos -->
                    <mp-list [columns]="listColumns" [items]="items.controls"
                        [noDataMessage]="'No se han agregado productos.'" class="purchase-order__list">
                    </mp-list>

                    <!-- Total de la orden -->
                    <div class="purchase-order__buttons">
                        <!-- Total alineado a la izquierda -->
                        <div class="purchase-order__total">
                            <span><strong>Total: {{ calculateTotal() | currency:'ARS':'symbol':'1.2-2'
                                    }}</strong></span>
                        </div>

                        <!-- Botón alineado a la derecha -->
                        <mp-button type="primary" (onClick)="onSubmit()" [disabled]="!form.valid"
                            class="purchase-order__buttons__item btn-confirm">
                            Guardar
                        </mp-button>
                    </div>
                </div>
            </mat-step>
        </mat-stepper>
    </div>
</div>