<ng-container *ngIf="isLoading(); else loaded">
  <mp-loading></mp-loading>
</ng-container>

<ng-template #loaded>
  <ng-container *ngIf="data() as detail">
    <div class="container">
      <div class="container__header">
        <div class="row mt-2">
          <div class="col-6">
            <strong>Fecha</strong>
            <p>{{detail.date | date:'dd/MM/yyyy'}}</p>
          </div>
          <div class="col-6 text-end">
            @if (detail.routeLink) {
            <a [href]="detail.routeLink" target="_blank" rel="noopener noreferrer" title="Ver ruta">
              <mat-icon>map</mat-icon>
            </a>
            }
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            @if (detail.finishedAt) {
            <strong>Finalizado</strong>
            <p>{{ detail.finishedAt | date:'dd/MM/yyyy' }}</p>
            }
          </div>
        </div>
        <div class="row">
          <div class="col-4">
            <strong>Estado</strong>
            <p>{{ getStatusLabel(detail.status)}}</p>
          </div>
          <div class="col-8 text-end">
            <strong>Vehículo</strong>
            <p>{{ detail.vehicle.licensePlate }} - {{ detail.vehicle.brand }} {{ detail.vehicle.model }}</p>
          </div>
        </div>
      </div>
      <hr>
      <div class="container__finalize">
        <form [formGroup]="finalizeForm">
          <mat-form-field appearance="outline" class="w-100 mb-2">
            <mat-label>Fecha de finalización</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="finishedAt" [min]="today" required />
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
          <mp-input
            label="Kilometraje final"
            type="number"
            formControlName="odometer"
            [min]="(data()?.vehicle?.kmTraveled ?? 0) + 1"
            placeholder="Ingrese el kilometraje"
            [errorMessages]="{
              min: 'El kilometraje debe ser mayor a ' + (data()?.vehicle?.kmTraveled ?? 0)
            }"
          ></mp-input>
        </form>
      </div>
      <hr />
      <div class="container__order text-center">
        <div class="container__order__title mb-2">Órdenes</div>
        <form [formGroup]="finalizeForm">
          <table class="order-table">
            <thead>
              <tr class="order-table__header-row">
                <th class="order-table__cell order-table__cell__id">N° ORDEN</th>
                <th class="order-table__cell order-table__cell__check">ENTREGADA</th>
              </tr>
            </thead>
            <tbody *ngIf="orderChecksArray as fa">
              <tr *ngFor="let order of data()?.orders; let i = index">
                <td class="order-table__cell order-table__cell__id">{{ order.id }}</td>
                <td class="order-table__cell order-table__cell__check">
                  <div class="order-table__checkbox-wrapper">
                    <mat-checkbox [formControl]="fa.at(i)"></mat-checkbox>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </form>
      </div>
    </div>
  </ng-container>